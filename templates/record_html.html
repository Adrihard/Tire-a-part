<html>
{{#i18n}}
<head>
  <title>{{i_record}}</title>
  <link rel="stylesheet" type="text/css" href="included/lib/jquery-ui-1.8.23.custom.css" />
  <link rel="stylesheet" type="text/css" href="included/main.css" />
  <meta charset="utf-8" />
  {{#creators}}
  <meta name="DC.creator" content="{{.}}" />
  {{/creators}}
  <meta name="DC.title" content="{{title}}" />
  <meta name="DC.relation.ispartof" content="{{ispartof}}" />
  <meta name="DC.citation.volume" content="{{volume}}" />
  <meta name="DC.citation.issue" content="{{issue}}" />
  <meta name="DC.citation.spage" content="{{spage}}" />
  <meta name="DC.citation.epage" content="{{epage}}" />
  <meta name="DC.publisher" content="{{publisher}}" />
  <meta name="DC.issued" content="{{issued}}" />
  {{#identifiers}}
  <meta name="DC.identifier" content="{{.}}" />
  {{/identifiers}}
  <script src="included/lib/jquery-1.8.0.min.js"></script>
  <script src="included/lib/jquery-ui-1.8.23.custom.min.js"></script>
  <script src="included/lib/jquery-form-3.19.js"></script>
  <script type="text/javascript">

  $(document).ready(function() {
    $("#aeresType").val("{{aeresType}}");
    $("[name=indexed]").val({{{indexed}}});
  });
	
  function save() {
    var pages = $("#pages").val().trim().split(/[-–]{1,2}/);
    var data = {
      "_attachments": {{{raw_attachments}}},
      "_rev": $("#rev").val(),
      "DC.creator": $("#creator").val().trim().split(/ *, */),
      "DC.title": $("#title").val().trim(),
      "DC.relation.ispartof": $("#ispartof").val().trim(),
      "DC.citation.volume": $("#volume").val().trim(),
      "DC.citation.issue": $("#issue").val().trim(),
      "DC.citation.spage": pages[0],
      "DC.citation.epage": pages[1],
      "DC.publisher": $("#publisher").val().trim(),
      "DC.issued": parseInt($("#issued").val()),
      "url": $("#url").val(),
      "indexed": $("input[name='indexed']:checked").map(function(){
        return $(this).val();
      }).get(),
      "aeresType": $("#aeresType").val(),
      "abstract": $("#abstract").val().trim()
    };
    $.ajax({
      url: "",
      type: "PUT",
      dataType: "json",
      contentType: "application/json",
      data: JSON.stringify(data),
      success: function(result) {
        $("#rev").val(result.rev);
        $("#upload_rev").val(result.rev);
      }
    });
  }

  function erase() {
    $("#dialog").text("{{i_delete?}}")
    .attr("title", "{{i_delete}}...")
    .dialog({
      modal: true,
      buttons: {
        {{i_delete}}: function() {
          $.ajax({
            url: "?rev=" + $("#rev").val(),
            type: "DELETE",
            success: function() {
              self.location = ".";
            }
          });
        },
        {{i_cancel}}: function() {
          $(this).dialog("close");
        }
      }
    });
  }

  function upload() {
    $("#footer").ajaxSubmit({
      success: function() {
        location.reload();
      }
    });
  }

  function toBibtex() {
    self.location = "?bibtex";
  }

  function fromBibtex() {
    $("#dialog")
    .attr("title", "{{i_import}}...")
    .html('<form><textarea cols="50" rows="12" type="text" id="bibtex" placeholder="BibTeX" /></form>')
    .dialog({
      modal: true,
      width: 400,
      buttons: {
        {{i_import}}: function() {
          var bibtex = parse($("#bibtex").val()); 
          $("#creator").val(bibtex.author);
          $("#title").val(bibtex.title);
          $("#ispartof").val(
            bibtex.journal? bibtex.journal : bibtex.booktitle
          );
          $("#volume").val(bibtex.volume);
          $("#issue").val(bibtex.number);
          $("#pages").val(bibtex.pages);
          $("#publisher").val(bibtex.publisher);
          $("#issued").val(bibtex.year);
          $("#url").val(bibtex.ee);
          $("#abstract").val(bibtex.abstract);
          $(this).dialog("close");
        },
        {{i_cancel}}: function() {
          $(this).dialog("close");
        }
      }
    });
  }

  const RECORD_BEGIN = /@(\w+)\s*\{[^,]*/;
  const ATTRIBUTE_BEGIN = /([\w\-]+)\s*=\s*[{"]/g;
  const ATTRIBUTE_END = /\}(?=\s*[,\}])/g;
  const TRAILING_COMMA = /,\s*\}/;
  const COMMENT = /(%.*)/g;
  const TABULATION = /\n\s{3,}/g;
  const INNER_QUOTE = /"(?=[^{\n]*})/g;
  const REMAINING_BRACE = /[{}]/g;
  const REMAINING_BACKSLASH = /\\(?!")/g;

  /**
   * @return object corresponding to the parsed BibTeX
   */
  function parse(bibtex) {
    var json = '{' + bibtex
      .replace(COMMENT, '')
      .replace(TABULATION, ' ')
      .replace(INNER_QUOTE, '\\\"')
      .replace(ATTRIBUTE_BEGIN, '"$1": "')
      .replace(ATTRIBUTE_END, '"')
      .replace(RECORD_BEGIN, '{"type": "$1"')
      .replace(TRAILING_COMMA, '')
      .replace(REMAINING_BRACE, '')
      .replace(/\\`a/g, "à")
      .replace(/\\\^a/g, "â")
      .replace(/\\"a/g, "ä")
      .replace(/\\'e/g, "é")
      .replace(/\\`e/g, "è")
      .replace(/\\\^e/g, "ê")
      .replace(/\\"e/g, "ë")
      .replace(/\\\^i/g, "î")
      .replace(/\\"i/g, "ï")
      .replace(/\\\^o/g, "ô")
      .replace(/\\"o/g, "ö")
      .replace(/\\`u/g, "ù")
      .replace(/\\\^u/g, "û")
      .replace(/\\"u/g, "ü")
      .replace(/\\cc/g, "ç")
      .replace(/\\`A/g, "À")
      .replace(/\\'E/g, "É")
      .replace(/\\\^E/g, "Ê")
      .replace(/\\cC/g, "Ç")
      .replace(REMAINING_BACKSLASH, "")
      + '}';
    var item = JSON.parse(json, function(key, value) {
      if (key.toLowerCase()==='author') {
        value = value.split(/ *and */);
        for (a in value) {
          value[a] = value[a].split(/, */).reverse().join(' ');
        }
      }
      return value;
    });
    return item;
  }

  </script>
</head>
<body>
  <div id="container">
    <div class="menu">
      <a href=".">{{i_back}}</a>
      <a id="help" href="https://github.com/benel/Tire-a-part/issues">?&nbsp;</a>
    </div>
    <form id="content">
      <table>
        <input id="rev" type="hidden" value="{{_rev}}" size="80" />
        <tr><th>{{i_creator}}</th>
          <td><input id="creator" type="text" value="{{formatted_creators}}" size="80" /></td>
        </tr>
        <tr><th>{{i_title}}</th>
          <td><input id="title" type="text" value="{{title}}" size="80" /></td>
        </tr>
        <tr><th>{{i_ispartof}}</th>
          <td><input id="ispartof" type="text" value="{{ispartof}}" size="80" /></td>
        </tr>
        <tr><th>{{i_volume}}</th>
          <td><input id="volume" type="text" value="{{volume}}" size="80" /></td>
        </tr>
        <tr><th>{{i_issue}}</th>
          <td><input id="issue" type="text" value="{{issue}}" size="80" /></td>
        </tr>
        <tr><th>{{i_pages}}</th>
          <td><input id="pages" type="text" value="{{spage}}{{#epage}}–{{epage}}{{/epage}}" size="80" /></td>
        </tr>
        <tr><th>{{i_publisher}}</th>
          <td><input id="publisher" type="text" value="{{publisher}}" size="80" /></td>
        </tr>
        <tr><th>{{i_issued}}</th>
          <td><input id="issued" type="text" value="{{issued}}" size="80" /></td>
        </tr>
        <tr><th>{{i_url}}</th>
          <td><input id="url" type="text" value="{{url}}" size="80" /></td>
        </tr>
        <tr><th>{{i_indexed}}</th><td>
          <label>
            <input type="checkbox" name="indexed" value="AERES" />AERES&nbsp;
          </label>
          <label>
            <input type="checkbox" name="indexed" value="ISI" />ISI&nbsp;
          </label>
          <label>
            <input type="checkbox" name="indexed" value="SCOPUS" />SCOPUS&nbsp;
          </label>
          <label>
            <input type="checkbox" name="indexed" value="ACM" />ACM&nbsp;
          </label>
          <label>
            <input type="checkbox" name="indexed" value="DBLP" />DBLP&nbsp;
          </label>
          <label>
            <input type="checkbox" name="indexed" value="INIST" />INIST&nbsp;
          </label>
        </td></tr>
        <tr><th>{{i_aeresType}}</th>
          <td><select id="aeresType">
            {{#i_aeresTypeValues}}
            <option value="{{key}}">{{label}}</option>
            {{/i_aeresTypeValues}}
          </select></td>
        </tr>
        <tr><th>{{i_abstract}}</th>
          <td>
            <textarea cols="80" rows="12" type="text" id="abstract">{{abstract}}</textarea>
          </td>
        </tr>
        <tr><th>{{i_offprint}}</th>
          <td><ul>
           {{#formatted_attachments}}
           <li>
             <a href="{{url}}">{{name}}</a>
             ({{size}} Mo)
           </li>
           {{/formatted_attachments}}
         </ul></td>
        </tr>
      </table>
    </form>
    <form id="footer" class="menu" enctype="multipart/form-data" method="post">
      <button type="button" onclick="fromBibtex()">{{i_import}}...</button>
      <button type="button" onclick="save()">{{i_save}}</button>
      <input id="upload_rev" type="hidden" name="_rev" value="{{_rev}}" />
      <input id="uploader" type="file" name="_attachments" />
      <button type="button" onclick="upload()">{{i_upload}}</button>
      <button type="button" onclick="toBibtex()">{{i_export}}</button>
      <button type="button" onclick="erase()">{{i_delete}}...</button>
      <div id="dialog" />
    </form>
  </div>
</body>
{{/i18n}}
</html>
